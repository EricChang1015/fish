<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>简易捕鱼游戏Demo - Phaser版本</title>
    <script src="public/libs/phaser.js"></script>
</head>
<body>
<script>
    class MainScene extends Phaser.Scene {
        constructor() {
            super();
            this.path01 = [0,100, 164, 46, 274, 142, 412, 57, 522, 141, 664, 64, 800, 140];
            // 预定义的路径
            this.paths = {
                //p01: new Phaser.Curves.Ellipse(700, 600, 900, 400),
                p02: new Phaser.Curves.Ellipse(-100, 50, 800, 400),
                p03: new Phaser.Curves.Ellipse(-100, 600, 900, 400),
                p04: new Phaser.Curves.Ellipse(700, 50, 800, 400),
                //splineTo from path01's second point to end
                p01: new Phaser.Curves.Path(0, 100).splineTo(this.path01.splice(2)),
                //p02: new Phaser.Curves.Path(800, 500).splineTo([664, 464, 522, 541, 412, 457, 274, 542, 164, 446, 0, 542]),
                //p04: new Phaser.Curves.Path(50, 300).lineTo(400, 100).lineTo(750, 300).lineTo(400, 500).lineTo(50, 300), // 示例路径

                // 可以定义更多路径...
            };
        }
        preload() {
            this.load.image('undersea', 'public/assets/img/bg.jpg');
            this.load.image('coral', 'public/assets/img/seabed.png');
            this.load.image('cannon_head', 'public/assets/img/cannon_head.png');
            this.load.image('cannon_body', 'public/assets/img/cannon_body.png');
            this.load.image('cursor', 'public/assets/img/cursor.png');
            this.load.image('bullet', 'public/assets/img/bullet.png');
            this.load.audioSprite('sfx', 'public/assets/audio/fx_mixdown.json', [
                'public/assets/audio/fx_mixdown.ogg'
            ]);

            // 加载鱼的动画
            this.load.atlas('sea', 'public/assets/animations/seacreatures_json.png', 'public/assets/animations/seacreatures_json.json');

        }

        create() {
            // size of the game
            this.add.image(400, 300, 'undersea');
            this.add.image(0, 466, 'coral').setOrigin(0);
            // for aimed object.
            this.customCursor = this.add.sprite(0, 0, 'cursor');
            this.customCursor.scale = 1.5;
            this.customCursor.setDepth(1000);
            this.customCursor.setVisible(false);
            // replace orignal cursor
            this.input.setDefaultCursor(`url('public/assets/img/cursor.png'), pointer`);
            
            // 初始化炮台，鱼，和子弹的组
            this.cannon1Head = this.add.image(100, config.height - 48, 'cannon_head').setDepth(1);
            this.add.image(100, config.height, 'cannon_body').setDepth(1);
            this.cannon2Head = this.add.image(config.width - 100, config.height - 48, 'cannon_head').setDepth(1);
            this.add.image(config.width - 100, config.height, 'cannon_body').setDepth(1);
            this.playerPosition = 1; // 玩家位置：0为左侧，1为右侧
            this.cannon = this.cannon2Head; // 初始炮台位置
            this.cannonOpposite = this.cannon1Head;
            let angle = -1.58;

            this.cannon1Balance = 1000;
            this.cannon2Balance = 1000;
            this.cannonBalanceText = [{}, {}];
            this.cannonBalanceText[0] = this.add.text(10, 10, `Balance: ${this.cannon1Balance}`, {
                fontSize: '16px',
                fill: '#FFF'
            });
            this.cannonBalanceText[1] = this.add.text(600, 10, `Balance: ${this.cannon2Balance}`, {
                fontSize: '16px',
                fill: '#FFF'
            });

            this.fishes = this.physics.add.group();
            this.bullets = this.physics.add.group();

            this.input.on('pointermove', (pointer) => {
                this.cannon = this.playerPosition === 0 ? this.cannon1Head : this.cannon2Head;
                angle = Phaser.Math.Angle.BetweenPoints(this.cannon, pointer);
                this.cannon.rotation = angle;
            });

            this.anims.create({ key: 'Fish_001', frames: this.anims.generateFrameNames('sea', { prefix: 'blueJellyfish', end: 32, zeroPad: 4 }), repeat: -1 });
            this.anims.create({ key: 'Fish_002', frames: this.anims.generateFrameNames('sea', { prefix: 'crab1', end: 25, zeroPad: 4 }), repeat: -1 });
            this.anims.create({ key: 'Fish_003', frames: this.anims.generateFrameNames('sea', { prefix: 'octopus', end: 24, zeroPad: 4 }), repeat: -1 });
            this.anims.create({ key: 'Fish_004', frames: this.anims.generateFrameNames('sea', { prefix: 'purpleFish', end: 20, zeroPad: 4 }), repeat: -1 });
            this.anims.create({ key: 'Fish_005', frames: this.anims.generateFrameNames('sea', { prefix: 'stingray', end: 23, zeroPad: 4 }), repeat: -1 });

            const graphics = this.add.graphics();
            graphics.lineStyle(1, 0xffffff, 1);

            this.paths.p01.draw(graphics, 128);
            this.paths.p02.draw(graphics, 128);
            this.paths.p03.draw(graphics, 128);
            this.paths.p04.draw(graphics, 128);


            // 添加自動射擊功能
            this.autoShootEnabled = false;
            this.autoShootButton = this.add.text(config.width / 2 - 100, 10, 'Auto Shoot: OFF', {
                font: 'bold 16px Arial',
                fill: '#f10f4b'
            })
                .setInteractive()
                .on('pointerdown', () => {
                    this.autoShootEnabled = !this.autoShootEnabled;
                    this.autoShootButton.setText(`Auto Shoot: ${this.autoShootEnabled ? 'ON' : 'OFF'}`);
                    if (this.autoShootEnabled) {
                        this.startAutoShooting();
                    }
                });


            // 点击发射子弹
            this.input.on('pointerdown', (pointer, gameObjects) => {
                if (gameObjects.length > 0 && gameObjects[0].getData('isFish') === true) {
                    let fish = gameObjects[0]; // Get the first clicked object which should be a fish
                    if (this.autoShootEnabled) {
                        console.log('auto shoot enabled fish.id:' + fish.getData('id'));
                        fish.setData('autoShoot', true);
                    }
                    this.shootBullet(pointer, fish);
                } else {
                    this.shootBullet(pointer);
                }
            });
            // 示例添加鱼
            //this.addAnimatedFish({type: 'Fish_001', x: 400, y: 100, speed: 0.2, id: 'f01_gR5NHC', angle:  Math.PI});
            // 这里可以通过socket或者其他方式接收服务器的鱼数据，然后生成鱼
            this.websocketHandler();
        }

        websocketHandler() {
            let _this = this;
            // 创建WebSocket连接
            let ws = new WebSocket('ws://localhost:8080');
            ws.onopen = function () {
                console.log('WebSocket connection established');
            };
            ws.onmessage = function (event) {
                let data = JSON.parse(event.data);
                if (data.result !== undefined) {
                    if (data.result.hit) {
                        let position = data.result.position;
                        let balance = data.result.balance;
                        _this.cannonBalanceText[position].setText(`Balance: ${balance}`);

                        console.log('hit:', data.result.fish.id);
                        // 從fishes群組中獲取所有魚的數組
                        let fishesArray = _this.fishes.getChildren();
                        // 查找id匹配的魚
                        let foundFish = fishesArray.find(fish => fish.getData('id') === data.result.fish.id);
                        if (foundFish) {
                            // 播放音效
                            _this.sound.playAudioSprite('sfx', 'death');

                            // 显示获胜金额
                            let winText = _this.add.text(foundFish.x, foundFish.y, `+${data.result.transaction.win}`, { fontSize: '20px', fill: '#dabb0d' });
                            winText.setOrigin(0.5, 0.5); // 使文本居中显示
                            // 使文本在一段时间后消失
                            _this.tweens.add({
                                targets: winText,
                                alpha: { from: 1, to: 0 },
                                ease: 'Linear', // 线性变化
                                duration: 1000, // 持续时间为1000毫秒
                                onComplete: () => {
                                    winText.destroy(); // 文本消失后销毁文本对象
                                }
                            });
                            _this.showCaptureAnimation(foundFish);
                        } else {
                            // 如果沒有找到匹配的魚
                            console.log('mismatch');
                        }
                    } else {
                        console.log('miss');
                        // update balance of player
                        let position = data.result.position;
                        let balance = data.result.balance;
                        _this.cannonBalanceText[position].setText(`Balance: ${balance}`);

                    }

                    return;
                }
                switch (data.action) {
                    case 'setPosition':
                        _this.playerPosition = data.position;
                        // 根据分配的位置调整炮台位置
                        this.cannon = this.playerPosition === 0 ? this.cannon1Head : this.cannon2Head;
                        this.cannonOpposite = this.playerPosition === 0 ? this.cannon2Head : this.cannon1Head;
                        break;
                    case 'fireBullet': { // 接收新的炮弹数据并添加到bullets数组中
                        // here, only show other's bullet
                        if (data.position !== _this.playerPosition) {
                            _this.showBullet(data, data.bullet.targetFishId);
                        }
                    }
                        break;
                    case 'fish': // 添加鱼到数组
                        _this.addFleet(data.fish);
                        break;

                    case 'error':
                        alert(data.message); // 显示错误消息
                        break;
                }
            };
            this.ws = ws;
        }

        update() {
            // Existing update logic...
            if (this.autoShootEnabled && this.fishes.getChildren().length > 0) {
                // 鎖定魚隻, 只取一隻
                let target = this.fishes.getChildren().find(fish => fish.getData('autoShoot'));
                if (target) {
                    this.customCursor.setPosition(target.x, target.y);
                    this.customCursor.setDepth(1000);
                    this.customCursor.setVisible(true);
                    this.cannon.rotation = Phaser.Math.Angle.Between(this.cannon.x, this.cannon.y, target.x, target.y);
                } else {
                    this.customCursor.setVisible(false);
                }
            }

            // 如果鎖定, 子彈導航到魚隻
            this.bullets.getChildren().forEach(bullet => {
                if (bullet.targetFish) {
                    let targetFish = this.fishes.getChildren().find(fish => fish.getData('id') === bullet.targetFish.getData('id'));
                    // 检查目标鱼是否已经不存在
                    if (targetFish == null) {
                        bullet.targetFish = null;  // 目标丢失，子弹恢复默认行为
                    } else {
                        this.physics.moveToObject(bullet, bullet.targetFish, config.bulletSpeed);
                    }
                }
            });

            for (const fish of this.fishes.getChildren()) {
                // // 檢查x位置是否變化，以確定是否需要翻轉
                // let previousX = fish.getData('previousX');
                // let PreviousY = fish.getData('previousY');
                // let diffX = fish.body.x - previousX;
                // let diffY = fish.body.y - PreviousY;
                // if (Math.abs(diffX) > 1) {
                //     if (diffX > 0) {
                //         fish.scaleX = -1; // 向右移動
                //     } else if (diffX < 0) {
                //         fish.scaleX = 1; // 向左移動
                //     }
                //     fish.setData('previousX', fish.body.x); // 更新前一位置，以便下次比較
                // }
                // if (Math.abs(diffY) > 1) {
                //     // 透過diffX,與diffY的比較，來決定魚的角度
                //     //fish.angle = Math.atan2(Math.abs(1), Math.abs(1)) * 180 / Math.PI;
                //     fish.setData('previousY', fish.body.y);
                // }
                this.checkFishValid(fish);
            }
        }

        checkFishValid(fish) {
            const timestamp = fish.getData('timestamp');
            const durationMS = fish.getData('durationMS');
            const isActive = (Date.now() < (timestamp + durationMS));

            if (!isActive && fish.active) {
                if (fish.getData('autoShoot')) {
                    this.customCursor.setVisible(false);
                }
                fish.destroy();
            }
        }

        showCaptureAnimation(fish) {
            fish.stopFollow(); // 停止沿路径移动
            this.fishes.remove(fish);
            this.tweens.add({
                targets: fish, // 目标是被击中的鱼
                scale: {from: 1, to: 1.5},
                alpha: {from: 1, to: 0},
                ease: 'Linear',
                duration: 100, // 持续时间100毫秒
                repeat: 3, // 重复5次，总共闪烁5次
                yoyo: true, // 完成一个动画周期后，再反向运行回到初始状态，实现闪烁
                onComplete: () => {
                    if (fish.getData('autoShoot')) {
                        this.customCursor.setVisible(false);
                    }
                    fish.destroy(); // 所有闪烁完成后，销毁鱼对象
                }
            });
        }

        // 當需要添加一組魚時
        addFleet(data) {
            // random number from 3 to 10
            const fleetSize = Math.floor(Math.random() * 5) + 2;
            for (let i = 1; i <= fleetSize; i++) {
                this.addFish(data, i);
            }
        }
        addFish(data, fleetId = 1) {
            // 根據 data 中的 pathId 選擇路徑
            let path = this.paths['p01'];
            if (!path) {
                console.error(`Path ${data.pathId} not found.`);
                return;
            }
            // 計算魚的初始位置和角度
            let offsetX = this.path01[0] , offsetY = this.path01[1] + 100;
            console.log('offsetX:', offsetX, 'offsetY:', offsetY)
            let radius = 50; // 圍繞中心魚的半徑
            if (fleetId > 3) { radius += 50;}
            if (fleetId !== 1) { // 不是中心魚時，計算偏移
                // Random angle
                let angle = Phaser.Math.DegToRad(Math.random() * 360);
                offsetX += Math.cos(angle) * radius;
                offsetY += Math.sin(angle) * radius;
            }

            // 創建帶有動畫的魚
            let fish = this.add.follower(path, offsetX, offsetY, 'seacreatures');
            fish.scale = 0.5;
            fish.scaleX *= -1; // 向右移動


            fish.startFollow({
                positionOnPath: false, //需要設定初始位置
                duration: 10000, // 鱼沿着路径移动所需的时间（毫秒）
                yoyo: false, // 如果想要鱼移动到路径末端然后返回，设置为 true
                repeat: -1, // -1 表示无限循环
                rotateToPath: false, // 自动旋转鱼以匹配路径方向
                verticalAdjust: true // 如果需要，可以调整鱼的垂直对齐
            }).play(data.type);

            fish.setInteractive();
            fish.on('pointerover', () => {
                fish.setTint(0xff0000);
            });
            fish.on('pointerout', () => {
                fish.clearTint();
            });

            this.fishes.add(fish);
            fish.setData('isFish', true);
            fish.setData('type', data.type);
            fish.setData('speed', data.speed);
            fish.setData('id', data.id + "." + fleetId); // 使用 fleetId 修改 ID
            fish.setData('previousX', data.x);
            fish.setData('previousY', data.y);
            fish.setData('timestamp', data.timestamp);
            fish.setData('durationMS', data.durationMS);
            fish.setData('pathId', data.pathId);
            fish.body.mass = config.fishMass;
            fish.body.setSize(1, 1);
            fish.body.onWorldBounds = true;
        }

        startAutoShooting() {
            console.log('start auto shooting');
            this.autoShootTimer = this.time.addEvent({
                delay: 500, // 100 ms between shots
                callback: () => {
                    if (!this.autoShootEnabled) {
                        console.log('stop auto shooting')
                        this.autoShootTimer.remove(false);
                        return;
                    }
                    let target = this.fishes.getChildren().find(fish => fish.getData('autoShoot'));
                    if (target !== undefined) {
                        console.log('auto shoot target:', target.getData('id'));
                        this.shootBullet(target, target);
                    }
                },
                loop: true
            });
        }

        shootBullet(pointer, targetFish = null) {
            const bulletId = generateBulletID();
            let bullet = this.bullets.create(this.cannon.x, this.cannon.y, 'bullet');
            bullet.setDisplaySize(100, 100);
            // set the rotation of the bullet to pointer
            bullet.rotation = this.physics.moveToObject(bullet, pointer, config.bulletSpeed);
            bullet.body.mass = config.bulletMass;
            bullet.setData('id', bulletId);
            // 子弹的碰撞检测
            this.physics.add.collider(bullet, this.fishes, this.hitFish, null, this);
            // 播放音效
            this.sound.playAudioSprite('sfx', 'shot');

            let data = {
                x: this.cannon.x,
                y: this.cannon.y,
                angle: bullet.rotation,
                speed: config.bulletSpeed,
                timestamp: Date.now(),
                id: bulletId
            };
            if (targetFish !== null && targetFish !== undefined) {
                bullet.targetFish = targetFish;  // 将目标鱼设置为子弹的属性
                data.targetFishId = targetFish.getData('id');
            }
            this.ws.send(JSON.stringify({action: 'fireBullet', bullet: data, position: this.playerPosition,}));
        }

        showBullet(data, targetFishId = null) {
            let rotation = data.bullet.angle;
            let speed = config.bulletSpeed;
            this.cannonOpposite = this.playerPosition === 0 ? this.cannon2Head : this.cannon1Head;
            // 发射子弹
            let bullet = this.bullets.create(this.cannonOpposite.x, this.cannonOpposite.y, 'bullet');
            bullet.setDisplaySize(100, 100);
            bullet.rotation = rotation;
            bullet.body.mass = config.bulletMass;
            this.physics.velocityFromRotation(rotation, speed, bullet.body.velocity);

            if (targetFishId !== null) {
                let targetFish = this.fishes.getChildren().find(fish => fish.getData('id') === targetFishId);
                if (targetFish) {
                    bullet.targetFish = targetFish;  // 将目标鱼设置为子弹的属性
                    this.physics.moveToObject(bullet, targetFish, config.bulletSpeed);
                }
            }

            // 子弹的碰撞检测
            this.physics.add.collider(bullet, this.fishes, this.showHitFish, null, this);
            this.cannonOpposite.rotation = rotation;
            // 播放音效
            this.sound.playAudioSprite('sfx', 'shot');
        }

        showHitFish(bullet, fish) {
            bullet.destroy();
            // 播放音效
            this.sound.playAudioSprite('sfx', 'boss hit');
        }

        hitFish(bullet, fish) {
            fish.body.stop(); // 避免子彈打到後, 對路徑的影響
            const bulletId = bullet.getData('id');
            bullet.destroy();
            // 播放音效
            this.sound.playAudioSprite('sfx', 'boss hit');
            // 这里可以发送击中信息给服务器
            //{"action":"hit","fish":{"type":"Fish_001","id":"f01_vDQvbz"},"bullet":{"id":"x8gCEtet0qJO"}}
            let data = {
                action: 'hit',
                fish: {
                    type: fish.getData('type'),
                    id: fish.getData('id')
                },
                bullet: {
                    id: bulletId,
                    bet: 5 //FIXME
                },
                position: this.playerPosition
            };
            //console.log('hit:', data);
            this.ws.send(JSON.stringify(data));
        }
    }

    function generateBulletID() {
        return generateRandomString(12)
    }

    function generateRandomString(length) {
        let result = '';
        let characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
        let charactersLength = characters.length;
        for (let i = 0; i < length; i++) {
            result += characters.charAt(Math.floor(Math.random() * charactersLength));
        }
        return result;
    }

    const config = {
        type: Phaser.WEBGL,
        parent: 'phaser-example',
        width: 800,
        height: 600,
        bulletSpeed: 600,
        bulletMass: 0.1,
        fishSpeed: 100,
        fishMass: 10,
        physics: {
            default: 'arcade',
            arcade: {
                gravity: {y: 0},
                debug: false
            }
        },
        scene: MainScene
    };

    const game = new Phaser.Game(config);
</script>
</body>
</html>
